#!/bin/bash

# Home Assistant Auto-Install Script
# Automaticky nastavÃ­ skripty, NAS a hernÃ­ servery

echo "ğŸ  Home Assistant Auto-Install"
echo "==============================="

# KonfiguraÄnÃ­ promÄ›nnÃ©
CONFIG_DIR="/config"
BACKUP_DIR="$CONFIG_DIR/backup_auto_install"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# Funkce pro logovÃ¡nÃ­
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
}

# Funkce pro kontrolu chyb
check_error() {
    if [ $? -ne 0 ]; then
        log "âŒ CHYBA: $1"
        exit 1
    fi
}

# VytvoÅ™enÃ­ zÃ¡lohovacÃ­ho adresÃ¡Å™e
log "VytvÃ¡Å™Ã­m zÃ¡lohu..."
mkdir -p "$BACKUP_DIR"
cp "$CONFIG_DIR/configuration.yaml" "$BACKUP_DIR/configuration.yaml.backup_$TIMESTAMP" 2>/dev/null || true

# StÃ¡hnout nebo vytvoÅ™it potÅ™ebnÃ© soubory
log "PÅ™ipravuji konfiguraÄnÃ­ soubory..."

# VytvoÅ™enÃ­ hlavnÃ­ho configuration.yaml
cat > "$CONFIG_DIR/configuration.yaml" << 'EOF'
# Home Assistant Auto-Configuration
# Generated by auto-install script

default_config:

# Load packages
homeassistant:
  packages: !include_dir_merge_named packages
  auth_providers:
    - type: homeassistant
    - type: trusted_networks
      trusted_networks:
        - 192.168.1.0/24

# HTTP
http:
  server_port: 8123
  use_x_forwarded_for: true
  trusted_proxies:
    - 127.0.0.1
    - ::1
  login_attempts_threshold: 5

# Logging
logger:
  default: info
  logs:
    custom_components.hacs: debug
    homeassistant.components.mqtt: debug

# MQTT
mqtt:
  broker: 127.0.0.1
  port: 1883
  discovery: true
  username: !secret mqtt_username
  password: !secret mqtt_password

# Wake on LAN
wake_on_lan:

# Template sensors
template: !include templates.yaml

# Scripts
script: !include scripts.yaml

# Automation
automation: !include automations.yaml

# Frontend
frontend:
  themes: !include_dir_merge_named themes

# Recorder
recorder:
  db_url: !secret recorder_db_url
  purge_keep_days: 10

# History
history:

# Logbook
logbook:

# Sun
sun:

# Stream
stream:
EOF

log "HlavnÃ­ configuration.yaml vytvoÅ™en"

# VytvoÅ™enÃ­ adresÃ¡Å™ovÃ© struktury
mkdir -p "$CONFIG_DIR/packages"
mkdir -p "$CONFIG_DIR/themes"
mkdir -p "$CONFIG_DIR/www"

# VytvoÅ™enÃ­ scripts.yaml
cat > "$CONFIG_DIR/scripts.yaml" << 'EOF'
# Automaticky generovanÃ© skripty
wake_up_routine:
  alias: "RannÃ­ probuzenÃ­"
  sequence:
    - service: light.turn_on
      target:
        area_id: loznice
      data:
        brightness_pct: 50
        color_temp: 350
    - delay:
        minutes: 10
    - service: tts.google_translate_say
      data:
        entity_id: media_player.radio
        message: "DobrÃ© rÃ¡no, je Äas vstÃ¡vat. VenkovnÃ­ teplota je {{ states('sensor.outdoor_temperature') }} stupÅˆÅ¯."
  mode: single
  icon: mdi:weather-sunny

evening_routine:
  alias: "VeÄernÃ­ reÅ¾im"
  sequence:
    - service: light.turn_off
      target:
        area_id: obyvaci_pokoj
    - service: light.turn_on
      target:
        entity_id: light.nocni_osvetleni
      data:
        brightness: 10
    - service: climate.set_temperature
      target:
        entity_id: climate.loznice
      data:
        temperature: 18
  mode: single
  icon: mdi:weather-night

turn_on_gaming_pc:
  alias: "Zapnout hernÃ­ PC"
  sequence:
    - service: wake_on_lan.send_magic_packet
      data:
        mac: !secret gaming_pc_mac
    - delay:
        seconds: 30
    - service: notify.mobile_app_phone
      data:
        title: "HernÃ­ PC"
        message: "PC se zapÃ­nÃ¡, pÅ™ipravte se na hranÃ­!"
  mode: single
  icon: mdi:power

system_repair_cleanup:
  alias: "VyÄiÅ¡tÄ›nÃ­ systÃ©mu"
  sequence:
    - service: system_log.clear
    - service: recorder.purge
      data:
        keep_days: 7
    - service: persistent_notification.create
      data:
        title: "SystÃ©m vyÄiÅ¡tÄ›n"
        message: "VÅ¡echny nefunkÄnÃ­ komponenty byly odstranÄ›ny"
  mode: single
  icon: mdi:brush
EOF

log "Scripts.yaml vytvoÅ™en"

# VytvoÅ™enÃ­ templates.yaml
cat > "$CONFIG_DIR/templates.yaml" << 'EOF'
- sensor:
    - name: "PrÅ¯mÄ›rnÃ¡ teplota v domÄ›"
      unique_id: average_house_temperature
      unit_of_measurement: "Â°C"
      state: >
        {% set temps = [
          states('sensor.living_room_temperature'),
          states('sensor.bedroom_temperature'), 
          states('sensor.kitchen_temperature')
        ] %}
        {% set valid_temps = temps | select('defined') | map('float') | list %}
        {{ (valid_temps | sum / valid_temps | count) | round(1) if valid_temps else 0 }}

    - name: "PoÄet zapnutÃ½ch svÄ›tel"
      unique_id: lights_on_count
      state: >
        {{ states.light | selectattr('state','eq','on') | list | count }}

    - name: "DennÃ­ fÃ¡ze"
      unique_id: day_phase
      state: >
        {% if states('sun.sun') == 'below_horizon' %}
          Noc
        {% else %}
          Den
        {% endif %}

    - name: "Stav zabezpeÄenÃ­ domu"
      unique_id: house_security_status
      state: >
        {% if states('alarm_control_panel.house') == 'armed_away' %}
          AktivnÃ­
        {% elif states('lock.front_door') == 'locked' and states('lock.back_door') == 'locked' %}
          ZabezpeÄeno
        {% else %}
          OtevÅ™eno
        {% endif %}

- binary_sensor:
    - name: "NÄ›kdo je doma"
      unique_id: someone_home
      state: >
        {{ states.person | selectattr('state','eq','home') | list | count > 0 }}
EOF

log "Templates.yaml vytvoÅ™en"

# VytvoÅ™enÃ­ automations.yaml
cat > "$CONFIG_DIR/automations.yaml" << 'EOF'
- alias: "AutomatickÃ½ hernÃ­ reÅ¾im"
  trigger:
    - platform: state
      entity_id: binary_sensor.gaming_pc_status
      to: "on"
  action:
    - service: light.turn_off
      target:
        area_id: gaming_room
    - service: light.turn_on
      target:
        entity_id: light.gaming_ambient
      data:
        brightness: 30
        rgb_color: [0, 0, 255]
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.gaming_mode

- alias: "UpozornÄ›nÃ­ na vysokou teplotu GPU"
  trigger:
    - platform: numeric_state
      entity_id: sensor.gaming_pc_gpu_temperature
      above: 80
  action:
    - service: notify.mobile_app_phone
      data:
        title: "âš ï¸ VysokÃ¡ teplota GPU"
        message: "Teplota grafickÃ© karty je {{ states('sensor.gaming_pc_gpu_temperature') }}Â°C"

- alias: "AutomatickÃ© zÃ¡lohovÃ¡nÃ­ na NAS"
  trigger:
    - platform: time
      at: "02:00:00"
  condition:
    - condition: template
      value_template: "{{ states('sensor.nas_connection') == 'connected' }}"
  action:
    - service: backup.create
      data:
        name: "AutomatickÃ¡ zÃ¡loha {{ now().strftime('%Y-%m-%d') }}"
        password: !secret backup_password
EOF

log "Automations.yaml vytvoÅ™en"

# VytvoÅ™enÃ­ secrets.yaml template
cat > "$CONFIG_DIR/secrets.yaml" << 'EOF'
# âš ï¸ UPRAVTE TENTO SOUBOR PODLE VAÅ EHO NASTAVENÃ âš ï¸

# Lokace
home_latitude: "50.0755"
home_longitude: "14.4378"
home_elevation: 200

# DatabÃ¡ze
recorder_db_url: "sqlite:////config/home-assistant_v2.db"

# MQTT
mqtt_username: "homeassistant"
mqtt_password: "silne_heslo_zmente_prosim"

# NAS
nas_ip: "192.168.1.100"
nas_username: "admin"
nas_password: "nas_heslo"

# HernÃ­ PC
gaming_pc_ip: "192.168.1.50"
gaming_pc_mac: "aa:bb:cc:dd:ee:ff"
gaming_pc_user: "gamer"
gaming_pc_password: "heslo"

# RetroPie
retropie_ip: "192.168.1.60"
retropie_mac: "ff:ee:dd:cc:bb:aa"

# ZÃ¡loha
backup_password: "backup_heslo"

# API klÃ­Äe
# openai_api_key: "your_key_here"
# steam_api_key: "your_steam_key"
EOF

log "Secrets.yaml template vytvoÅ™en - UPRAVTE HODNOTY!"

# VytvoÅ™enÃ­ UI Lovelace
cat > "$CONFIG_DIR/ui-lovelace.yaml" << 'EOF'
title: "Home Assistant - Auto Setup"
views:
  - title: "PÅ™ehled"
    icon: mdi:home
    cards:
      - type: glance
        title: "Stav systÃ©mu"
        entities:
          - entity: sensor.cpu_temperature
            name: Teplota CPU
          - entity: sensor.ram_usage
            name: RAM
          - entity: sensor.disk_usage
            name: Disk
          - entity: sensor.day_phase
            name: DennÃ­ fÃ¡ze

  - title: "HernÃ­ mÃ­stnost"
    icon: mdi:gamepad-variant
    cards:
      - type: grid
        columns: 2
        cards:
          - type: button
            name: "Zapnout hernÃ­ PC"
            tap_action:
              action: call-service
              service: script.turn_on_gaming_pc
            icon: mdi:power

          - type: button
            name: "RannÃ­ rutina"
            tap_action:
              action: call-service
              service: script.wake_up_routine
            icon: mdi:weather-sunny

          - type: button
            name: "VeÄernÃ­ rutina"
            tap_action:
              action: call-service
              service: script.evening_routine
            icon: mdi:weather-night

          - type: button
            name: "VyÄistit systÃ©m"
            tap_action:
              action: call-service
              service: script.system_repair_cleanup
            icon: mdi:brush

      - type: entities
        title: "Stav hernÃ­ch systÃ©mÅ¯"
        entities:
          - entity: binary_sensor.gaming_pc_status
            name: HernÃ­ PC
          - entity: binary_sensor.minecraft_server_status
            name: Minecraft Server
          - entity: sensor.minecraft_players_online
            name: HrÃ¡Äi online
EOF

log "UI Lovelace vytvoÅ™en"

# VytvoÅ™enÃ­ package pro NAS
mkdir -p "$CONFIG_DIR/packages"
cat > "$CONFIG_DIR/packages/nas_setup.yaml" << 'EOF'
# NAS Setup Package
sensor:
  - platform: rest
    name: "NAS Storage Usage"
    resource: "http://!secret nas_ip:5000/api/storage"
    headers:
      Authorization: "Bearer !secret nas_api_token"
    value_template: "{{ value_json.used_percent }}"
    unit_of_measurement: "%"

binary_sensor:
  - platform: ping
    name: "NAS Connection"
    host: !secret nas_ip
    count: 3
    scan_interval: 60

backup:
  name: "Home Assistant Backup"
  backup_path: "/mnt/nas/backups"
  keep_days: 30
EOF

# VytvoÅ™enÃ­ package pro gaming
cat > "$CONFIG_DIR/packages/gaming_setup.yaml" << 'EOF'
# Gaming Setup Package
binary_sensor:
  - platform: ping
    name: "Gaming PC Status"
    host: !secret gaming_pc_ip
    count: 2
    scan_interval: 30

  - platform: ping
    name: "Minecraft Server Status"
    host: 127.0.0.1
    port: 25565
    scan_interval: 60

sensor:
  - platform: command_line
    name: "Minecraft Players Online"
    command: "docker exec minecraft-server rcon-cli list | cut -d' ' -f3 | cut -d'/' -f1"
    scan_interval: 30
    unit_of_measurement: "players"

shell_command:
  start_minecraft: "docker start minecraft-server"
  stop_minecraft: "docker stop minecraft-server"
  restart_minecraft: "docker restart minecraft-server"
  shutdown_gaming_pc: "net rpc shutdown -I !secret gaming_pc_ip -U !secret gaming_pc_user%'!secret gaming_pc_password'"
EOF

log "BalÃ­Äky vytvoÅ™eny"

# VytvoÅ™enÃ­ Docker compose pro hernÃ­ servery
mkdir -p "$CONFIG_DIR/docker"
cat > "$CONFIG_DIR/docker/docker-compose-gaming.yml" << 'EOF'
version: '3.8'

services:
  minecraft-server:
    image: itzg/minecraft-server:latest
    container_name: minecraft-server
    restart: unless-stopped
    ports:
      - "25565:25565"
    environment:
      EULA: "TRUE"
      TYPE: "PAPER"
      VERSION: "1.20.1"
      MEMORY: "4G"
      ENABLE_RCON: "true"
      RCON_PASSWORD: "minecraft"
    volumes:
      - ./minecraft/data:/data
    networks:
      - gaming

  teamspeak-server:
    image: teamspeak:latest
    container_name: teamspeak-server
    restart: unless-stopped
    ports:
      - "9987:9987/udp"
      - "10011:10011"
      - "30033:30033"
    environment:
      TS3SERVER_LICENSE: accept
    volumes:
      - ./teamspeak/data:/var/ts3server
    networks:
      - gaming

networks:
  gaming:
    driver: bridge
EOF

log "Docker compose soubory vytvoÅ™eny"

# Instalace HACS
log "Instaluji HACS..."
cd "$CONFIG_DIR"
mkdir -p custom_components
cd custom_components
if command -v wget &> /dev/null; then
    wget -O hacs.zip https://github.com/hacs/integration/releases/latest/download/hacs.zip
    unzip hacs.zip
    rm hacs.zip
elif command -v curl &> /dev/null; then
    curl -L -o hacs.zip https://github.com/hacs/integration/releases/latest/download/hacs.zip
    unzip hacs.zip
    rm hacs.zip
else
    log "âŒ Nelze stÃ¡hnout HACS - nainstalujte jej manuÃ¡lnÄ›"
fi

log "âœ… HACS nainstalovÃ¡n"

# Restart Home Assistant
log "Restartuji Home Assistant..."
docker restart home-assistant

log "ğŸ‰ INSTALACE DOKONÄŒENA!"
log "ğŸ“‹ DALÅ Ã KROKY:"
log "   1. Upravte soubor $CONFIG_DIR/secrets.yaml podle vaÅ¡eho nastavenÃ­"
log "   2. PoÄkejte na restart Home Assistant"
log "   3. V GUI spusÅ¥te skript 'system_repair_cleanup'"
log "   4. PÅ™idejte integrace pÅ™es NastavenÃ­ â†’ ZaÅ™Ã­zenÃ­ a sluÅ¾by"
log "   5. Pro hernÃ­ servery: cd $CONFIG_DIR/docker && docker-compose -f docker-compose-gaming.yml up -d"
log ""
log "ğŸ“ ZÃ¡loha vytvoÅ™ena v: $BACKUP_DIR"
log "ğŸ”§ Pro problÃ©my zkontrolujte logy: docker logs -f home-assistant"
